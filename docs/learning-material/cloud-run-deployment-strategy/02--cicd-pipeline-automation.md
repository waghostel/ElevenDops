# CI/CD æµç¨‹è‡ªå‹•åŒ– (CI/CD Pipeline Automation)

## é—œéµå­—

- **Cloud Build**ï¼šGCP çš„è¨—ç®¡å»ºç½®æœå‹™ã€‚
- **Artifact Registry**ï¼šç”¨æ–¼å„²å­˜èˆ‡ç®¡ç† Docker æ˜ åƒæª”çš„å€‰åº«ã€‚
- **GitHub Trigger**ï¼šç•¶ç¨‹å¼ç¢¼æ¨é€è‡³ç‰¹å®šåˆ†æ”¯æ™‚è§¸ç™¼è‡ªå‹•å»ºç½®ã€‚
- **cloudbuild.yaml**ï¼šå®šç¾© CI/CD æ­¥é©Ÿçš„é…ç½®æª”æ¡ˆã€‚

## å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« ç¯€å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

1. ç†è§£ ElevenDops çš„è‡ªå‹•åŒ–éƒ¨ç½²æ¨¡å‹ã€‚
2. è§£æ `cloudbuild.yaml` ä¸­çš„å„å€‹æ­¥é©Ÿã€‚
3. æŒæ¡å¾ç¨‹å¼ç¢¼æ¨é€è‡³æœå‹™æ›´æ–°çš„å®Œæ•´æµç¨‹ã€‚

## æ­¥é©Ÿèªªæ˜

### æ­¥é©Ÿ 1ï¼šå®šç¾©è‡ªå‹•åŒ–å»ºç½®æ­¥é©Ÿ

#### æˆ‘å€‘åœ¨åšä»€éº¼ï¼Ÿ

é€é `cloudbuild.yaml` å®šç¾©æ˜ åƒæª”å»ºç½®ã€ä¸Šå‚³èˆ‡éƒ¨ç½²çš„ä¸‰éƒ¨æ›²ã€‚

#### ç‚ºä»€éº¼éœ€è¦é€™æ¨£åšï¼Ÿ

æ‰‹å‹•éƒ¨ç½²å®¹æ˜“å‡ºéŒ¯ä¸”è€—æ™‚ã€‚è‡ªå‹•åŒ–æµç¨‹ç¢ºä¿æ¯æ¬¡ç™¼å¸ƒéƒ½ç¶“éç›¸åŒçš„æ­¥é©Ÿï¼Œä¸¦èƒ½è¼•é¬†è¿½è¹¤ç‰ˆæœ¬ç•°å‹•ï¼ˆé€é Commit SHAï¼‰ã€‚

#### æµç¨‹åœ–

```mermaid
sequenceDiagram
    participant Dev as é–‹ç™¼è€…
    participant GH as GitHub
    participant CB as Cloud Build
    participant AR as Artifact Registry
    participant CR as Cloud Run

    Dev->>GH: Push to main
    GH->>CB: è§¸ç™¼å»ºç½®
    CB->>CB: Docker Build
    CB->>AR: Pushing Image
    AR-->>CR: éƒ¨ç½²æ›´æ–°
    CR-->>Dev: éƒ¨ç½²æˆåŠŸé€šçŸ¥
```

### æ­¥é©Ÿ 2ï¼šè§£æ cloudbuild.yaml

#### æˆ‘å€‘åœ¨åšä»€éº¼ï¼Ÿ

äº†è§£å»ºç½®é…ç½®ä¸­çš„ `build`ã€`push` èˆ‡ `deploy` æ ¸å¿ƒ IDã€‚

#### ç‚ºä»€éº¼éœ€è¦é€™æ¨£åšï¼Ÿ

é€™æ˜¯ CI/CD çš„æ ¸å¿ƒé‚è¼¯ã€‚æ­£ç¢ºé…ç½® `args` èˆ‡ç’°å¢ƒè®Šæ•¸æ˜¯ç¢ºä¿éƒ¨ç½²æˆåŠŸçš„é—œéµã€‚

#### ç¨‹å¼ç¢¼ç¯„ä¾‹

```yaml
steps:
  # æ­¥é©Ÿ 1: å»ºç½®æ˜ åƒæª”
  - name: "gcr.io/cloud-builders/docker"
    id: "build"
    args:
      ["build", "-t", "my-image:${SHORT_SHA}", "-f", "Dockerfile.cloudrun", "."]

  # æ­¥é©Ÿ 3: éƒ¨ç½²è‡³ Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy"
    entrypoint: "gcloud"
    args:
      - "run"
      - "deploy"
      - "elevendops"
      - "--image"
      - "my-image:${SHORT_SHA}"
      - "--region"
      - "us-central1"
```

## å¸¸è¦‹å•é¡Œ Q&A

### Q1ï¼š`SHORT_SHA` æ˜¯ä»€éº¼ï¼Ÿåœ¨å“ªè£¡å¯ä»¥æ‰¾åˆ°ï¼Ÿ

**ç­”ï¼š** é€™æ˜¯ Cloud Build è‡ªå‹•æä¾›çš„è®Šæ•¸ï¼Œä»£è¡¨è©²æ¬¡ Git æäº¤çš„çŸ­é›œæ¹Šå€¼ï¼ˆ7 ä½ï¼‰ã€‚ç”¨æ–¼å¹«æ˜ åƒæª”æ‰“ä¸Šå”¯ä¸€æ¨™ç±¤ï¼Œæ–¹ä¾¿æ—¥å¾Œå›æ»¾ã€‚

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ° `SHORT_SHA`ï¼š

| ä½ç½®                      | èªªæ˜                                    |
| ------------------------- | --------------------------------------- |
| **Cloud Build â†’ History** | å»ºç½®ç´€éŒ„çš„ Commit æ¬„ä½                  |
| **Artifact Registry**     | æ˜ åƒæ¨™ç±¤ï¼Œå¦‚ `app:a1b2c3d`              |
| **Cloud Run â†’ Revisions** | ç‰ˆæœ¬åç¨±ï¼Œå¦‚ `elevendops-00042-a1b2c3d` |
| **æœ¬åœ° Git**              | åŸ·è¡Œ `git rev-parse --short HEAD`       |

å…¶ä»–å¸¸ç”¨å…§å»ºè®Šæ•¸ï¼š`${COMMIT_SHA}`ï¼ˆå®Œæ•´ 40 ä½ï¼‰ã€`${BRANCH_NAME}`ã€`${PROJECT_ID}`ã€‚

### Q2ï¼šå»ºç½®å¤±æ•—æ€éº¼è¾¦ï¼Ÿ

**ç­”ï¼š** æ‚¨å¯ä»¥å‰å¾€ GCP æ§åˆ¶å°çš„ Cloud Build æ­·å²ç´€éŒ„æŸ¥çœ‹è©³ç´°æ—¥èªŒã€‚å¸¸è¦‹åŸå› åŒ…æ‹¬ Dockerfile èªæ³•éŒ¯èª¤æˆ–è™›æ“¬æ©Ÿå™¨è¨˜æ†¶é«”ä¸è¶³ã€‚

### Q3ï¼šDocker Build å’Œ Pushing Image çš„å·®åˆ¥æ˜¯ä»€éº¼ï¼Ÿ

**ç­”ï¼š** é€™æ˜¯å…©å€‹ä¸åŒçš„æ­¥é©Ÿï¼š

| æ­¥é©Ÿ              | å‹•ä½œ       | èªªæ˜                                                                                     |
| ----------------- | ---------- | ---------------------------------------------------------------------------------------- |
| **Docker Build**  | å»ºç½®æ˜ åƒæª” | åœ¨ Cloud Build è™›æ“¬æ©Ÿå™¨ä¸ŠåŸ·è¡Œ `docker build`ï¼Œæ ¹æ“š Dockerfile ç”¢ç”Ÿæ˜ åƒæª”ï¼ˆæš«å­˜åœ¨è¨˜æ†¶é«”ï¼‰ |
| **Pushing Image** | æ¨é€æ˜ åƒæª” | åŸ·è¡Œ `docker push`ï¼Œå°‡æ˜ åƒæª”ä¸Šå‚³åˆ° **Artifact Registry** æ°¸ä¹…å„²å­˜                        |

ç°¡å–®ä¾†èªªï¼šBuild æ˜¯ã€Œè£½ä½œã€æ˜ åƒæª”ï¼ŒPush æ˜¯ã€Œä¸Šå‚³ã€åˆ°å„²å­˜åº«ã€‚Cloud Run æœƒå¾ Artifact Registry æ‹‰å–æ˜ åƒæª”ä¾†éƒ¨ç½²ã€‚

### Q4ï¼šæœ‰äº† cloudbuild.yaml å°±æœƒè‡ªå‹•åœ¨ GitHub push æ™‚å»ºç½®å—ï¼Ÿ

**ç­”ï¼š** ä¸æ˜¯ï¼åƒ…æœ‰ `cloudbuild.yaml` é‚„ä¸å¤ ï¼Œæ‚¨é‚„éœ€è¦åœ¨ GCP ä¸­è¨­å®š **Cloud Build Triggerï¼ˆè§¸ç™¼å™¨ï¼‰**ã€‚

| é …ç›®                    | èªªæ˜                                   | è¨­å®šä½ç½®         |
| ----------------------- | -------------------------------------- | ---------------- |
| **cloudbuild.yaml**     | å®šç¾©ã€Œæ€éº¼å»ºç½®ã€ï¼ˆæ­¥é©Ÿã€å‘½ä»¤ï¼‰         | å°ˆæ¡ˆç¨‹å¼ç¢¼æ ¹ç›®éŒ„ |
| **Cloud Build Trigger** | å®šç¾©ã€Œä½•æ™‚å»ºç½®ã€ï¼ˆå“ªå€‹åˆ†æ”¯ã€å“ªå€‹äº‹ä»¶ï¼‰ | GCP Console      |

è¨­å®šæ­¥é©Ÿï¼šGCP Console â†’ Cloud Build â†’ Triggers â†’ Create Triggerï¼Œç„¶å¾Œé€£æ¥ GitHub å€‰åº«ä¸¦æŒ‡å®š `^main$` åˆ†æ”¯ã€‚è§¸ç™¼å™¨æœƒåœ¨æ¯æ¬¡ push æ™‚è‡ªå‹•æ³¨å…¥ `${PROJECT_ID}`ã€`${SHORT_SHA}` ç­‰è®Šæ•¸ã€‚

### Q5ï¼šå¯ä»¥æš«æ™‚åœç”¨ Trigger æˆ–æ‰‹å‹•è§¸ç™¼ç‰¹å®šç‰ˆæœ¬å—ï¼Ÿ

**ç­”ï¼š** å¯ä»¥ï¼æœ‰ä»¥ä¸‹å¹¾ç¨®æ–¹å¼æ§åˆ¶å»ºç½®ï¼š

| æ–¹æ³•             | æ“ä½œæ–¹å¼                                           | é©ç”¨å ´æ™¯     |
| ---------------- | -------------------------------------------------- | ------------ |
| **åœç”¨ Trigger** | GCP Console â†’ Triggers â†’ é¸æ“‡ â†’ Disable            | æš«åœè‡ªå‹•éƒ¨ç½² |
| **æ‰‹å‹•è§¸ç™¼**     | Triggers â†’ Run â†’ é¸æ“‡ Branch æˆ– Commit SHA         | éƒ¨ç½²ç‰¹å®šç‰ˆæœ¬ |
| **gcloud CLI**   | `gcloud builds triggers run <name> --sha=<commit>` | å‘½ä»¤åˆ—æ“ä½œ   |

åœç”¨å¾Œè§¸ç™¼å™¨è¨­å®šä»ä¿ç•™ï¼Œå¯éš¨æ™‚é‡æ–°å•Ÿç”¨ã€‚

### Q6ï¼šä»€éº¼æ˜¯ Tag Triggerï¼Ÿå¦‚ä½•åªåœ¨ç‰¹å®šç‰ˆæœ¬æ‰å»ºç½®ï¼Ÿ

**ç­”ï¼š** Tag Trigger è®“æ‚¨åªåœ¨ push Git Tag æ™‚æ‰è§¸ç™¼å»ºç½®ï¼Œè€Œéæ¯æ¬¡ push éƒ½éƒ¨ç½²ã€‚

**è¨­å®šæ–¹å¼ï¼š** å»ºç«‹æ–° Triggerï¼ŒEvent é¸æ“‡ `Push new tag`ï¼ŒTag pattern è¨­ç‚º `^v[0-9]+\.[0-9]+\.[0-9]+$`ï¼ˆåŒ¹é… v1.0.0 æ ¼å¼ï¼‰ã€‚

**ä½¿ç”¨æµç¨‹ï¼š**

```bash
# ä¸€èˆ¬ push ä¸æœƒè§¸ç™¼
git push origin main  # âŒ ä¸è§¸ç™¼

# æ‰“ Tag ä¸¦ push æ‰æœƒè§¸ç™¼
git tag v1.0.0
git push origin v1.0.0  # âœ… è§¸ç™¼å»ºç½®
```

Tag çš„å¥½è™•ï¼šç²¾ç¢ºæ§åˆ¶ç™¼å¸ƒç‰ˆæœ¬ã€æ–¹ä¾¿å›æ»¾ã€æ”¯æ´èªç¾©åŒ–ç‰ˆæœ¬è™Ÿã€‚

### Q7ï¼šå¦‚ä½•å›æ»¾åˆ°å‰ä¸€å€‹ç‰ˆæœ¬ï¼Ÿ

**ç­”ï¼š** Cloud Run ä¿ç•™æ‰€æœ‰ Revisionï¼Œå›æ»¾éå¸¸å¿«é€Ÿï¼š

| æ–¹æ³•         | æ“ä½œ                                                                          | é€Ÿåº¦      |
| ------------ | ----------------------------------------------------------------------------- | --------- |
| **Console**  | Cloud Run â†’ Revisions â†’ é¸æ“‡èˆŠç‰ˆ â†’ Manage Traffic â†’ 100%                      | âš¡ ç§’ç´š   |
| **gcloud**   | `gcloud run services update-traffic elevendops --to-revisions=<revision>=100` | âš¡ ç§’ç´š   |
| **é‡æ–°éƒ¨ç½²** | `gcloud run deploy --image=...app:<èˆŠç‰ˆSHORT_SHA>`                            | ğŸ• åˆ†é˜ç´š |

ä¹Ÿå¯ä»¥ç”¨æµé‡åˆ†é…åšæ¼¸é€²å¼å›æ»¾ï¼š`--to-revisions=æ–°ç‰ˆ=90,èˆŠç‰ˆ=10`ã€‚

## é‡é»æ•´ç†

| å·¥å…·              | ç”¨é€”       | å„ªé»                      |
| ----------------- | ---------- | ------------------------- |
| GitHub            | åŸå§‹ç¢¼ç®¡ç† | æ˜“æ–¼å”ä½œã€è§¸ç™¼å·¥ä½œæµ      |
| Cloud Build       | åŸ·è¡Œå»ºç½®   | è¨—ç®¡ç’°å¢ƒã€å…é…ç½®ä¼ºæœå™¨    |
| Artifact Registry | æ˜ åƒæª”ç®¡ç† | å®‰å…¨å¯é ã€èˆ‡ GCP æ•´åˆåº¦é«˜ |

## å»¶ä¼¸é–±è®€

- [Cloud Build ä½¿ç”¨æŒ‡å—](../../docs/cloud-run-deployment/guide--cicd-pipeline.md)
- [GCP Artifact Registry èªªæ˜](https://cloud.google.com/artifact-registry/docs)

---

## åƒè€ƒç¨‹å¼ç¢¼ä¾†æº

æœ¬æ–‡ä»¶ä¸­çš„ç¨‹å¼ç¢¼ç¯„ä¾‹åƒè€ƒè‡ªä»¥ä¸‹å°ˆæ¡ˆæª”æ¡ˆï¼š

| æª”æ¡ˆè·¯å¾‘          | èªªæ˜                   |
| ----------------- | ---------------------- |
| `cloudbuild.yaml` | é€šç”¨çš„å»ºç½®èˆ‡éƒ¨ç½²è¨­å®šæª” |

---

[â¬…ï¸ è¿”å› Cloud Run éƒ¨ç½²ç­–ç•¥ç´¢å¼•](./index.md)
