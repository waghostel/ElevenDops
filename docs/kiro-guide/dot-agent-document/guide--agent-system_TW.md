# `.agent` 目錄系統

本文件說明 `.agent` 目錄如何與 Antigravity 等 AI 程式編輯助手協同工作。它作為一個結構化的工作空間，用於定義可重複使用的工作流程、規則和指令，以引導 AI 在專案中的行為。

---

## 概述

`.agent` 目錄是一個**專案層級的配置空間**，允許開發者自訂 AI 助手與其程式碼庫的互動方式。不同於單一的龐大指令檔案，它採用模組化、延遲載入的方式來提升效率。

```
.agent/
├── workflows/          # 標準作業流程
│   ├── build.md
│   ├── deploy.md
│   └── test.md
├── rules/              # 專案範圍的程式碼規範（選用）
│   └── naming-conventions.md
└── instructions.md     # 全域代理指令（選用）
```

---

## 核心概念

### 1. 延遲載入（按需載入上下文）

`.agent/` 中的檔案**不會**在每次對話開始時預先載入到 AI 的上下文視窗中。取而代之的是：

1.  AI 維護一個可用檔案的**索引**（低開銷）。
2.  檔案**僅在相關時**才會載入（例如，當使用者調用指令或 AI 偵測到相關任務時）。
3.  這樣可以保留上下文視窗容量給程式碼、錯誤訊息和對話歷史。

### 2. 斜線指令調用

工作流程檔案可以透過**斜線指令**根據其檔名來觸發：

| 檔案路徑                             | 斜線指令          |
| :----------------------------------- | :---------------- |
| `.agent/workflows/build.md`          | `/build`          |
| `.agent/workflows/deploy-staging.md` | `/deploy-staging` |

---

## 工作流程（`workflows/`）

工作流程是 `.agent` 系統的主要功能。它們定義了常見任務的逐步程序。

### 檔案格式

每個工作流程檔案使用 YAML 前置資料，後接 Markdown 內容：

````markdown
---
description: 如何執行測試套件
---

# 測試工作流程

## 前置條件

確保虛擬環境已啟動。

## 步驟

1. 安裝相依套件
   // turbo

```powershell
uv sync
```
````

2. 執行 pytest
   // turbo

```powershell
uv run pytest tests/ -v
```

3. 檢查覆蓋率報告

```powershell
uv run pytest --cov=backend tests/
```

````

### Turbo 標註

特殊標註控制自動執行：

| 標註            | 範圍         | 效果                                   |
| :-------------- | :----------- | :------------------------------------- |
| `// turbo`      | 單一步驟     | 自動執行緊接在後的指令。               |
| `// turbo-all`  | 整個檔案     | 自動執行工作流程中的每個指令。         |

> [!CAUTION]
> 僅對安全、非破壞性的指令使用 `// turbo`（例如 `uv sync`、`pnpm install`）。避免對會刪除檔案或修改生產資料的指令使用它。

---

## 規則（`rules/`）（選用）

`rules/` 子目錄可以存放定義 AI 在生成程式碼時應遵循的**約束和慣例**的檔案。

### 範例：`rules/api-design.md`

```markdown
---
description: 本專案的 API 設計指南
---

# API 設計規則

1.  所有端點必須回傳具有一致封裝的 JSON：
    ```json
    { "data": ..., "error": null }
    ```
2.  所有 JSON 鍵名使用 `snake_case`。
3.  分頁必須使用 `offset` 和 `limit` 查詢參數。
````

當 AI 處理與 API 相關的程式碼時，可以參考此檔案以確保合規。

---

## 全域指令（`instructions.md`）（選用）

在 `.agent/` 根目錄下的單一 `instructions.md` 檔案可以提供適用於所有任務的高階指導。

### 範例：`.agent/instructions.md`

```markdown
# 專案指令

- 這是一個醫療器材文件平台。
- 優先考慮程式碼清晰度而非簡潔性。
- 始終為公開函式加入文件字串。
- 不確定時，在繼續之前先尋求澄清。
```

---

## `.agent` 系統的優點

| 優點           | 說明                                                              |
| :------------- | :---------------------------------------------------------------- |
| **模組化**     | 不同關注點分開檔案；易於新增、更新或移除。                        |
| **上下文效率** | 延遲載入避免浪費上下文視窗空間。                                  |
| **團隊一致性** | 標準化的工作流程確保所有團隊成員（和 AI）遵循相同的標準作業流程。 |
| **版本控制**   | 與程式碼庫一起存放在 Git 中；變更可追蹤和審查。                   |

---

## 快速開始

1.  **建立目錄結構：**

    ```powershell
    mkdir .agent\workflows
    ```

2.  **新增您的第一個工作流程：**
    建立 `.agent/workflows/dev-setup.md`：

    ````markdown
    ---
    description: 設定開發環境
    ---

    # 開發環境設定

    // turbo-all

    1. 安裝 Python 相依套件

    ```powershell
    uv sync
    ```
    ````

    2. 複製環境檔案

    ```powershell
    Copy-Item .env.example .env
    ```

    ```

    ```

3.  **調用它：**
    在您的 AI 對話中，輸入 `/dev-setup`，AI 將會依照步驟執行。

---

> [!TIP]
> 從小處開始！先為您最重複性的任務新增一兩個工作流程（例如執行測試、啟動開發伺服器），然後根據需要擴展。
