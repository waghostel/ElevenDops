============================= test session starts =============================
platform win32 -- Python 3.11.0, pytest-8.4.2, pluggy-1.6.0
rootdir: C:\Users\Cheney\Documents\Github\ElevenDops
configfile: pyproject.toml
plugins: anyio-4.12.0, hypothesis-6.148.7, langsmith-0.5.0, asyncio-0.24.0
asyncio: mode=Mode.AUTO, default_loop_scope=None
collected 4 items

tests\test_education_audio_integration.py .FF.                           [100%]

================================== FAILURES ===================================
_________________________ test_script_generation_flow _________________________

mock_client = <MagicMock id='2289377024464'>

    def test_script_generation_flow(mock_client):
        """Test selecting a document and generating a script."""
        with patch("streamlit_app.services.backend_api.get_backend_client", return_value=mock_client):
            at = AppTest.from_file("streamlit_app/pages/3_Education_Audio.py", default_timeout=30)
            at.session_state["IS_TESTING_BACKEND"] = True
            at.run()
    
            # Select document "Flu" at index 0
            at.selectbox[0].select_index(0).run()
    
            # Check raw content expanded
            assert "Flu guide content" in at.markdown[1].value
    
            # Click Generate Script button
            at.button(key="generate_script_btn").click().run()
    
            # Verify script appears in text area
            # Check using key if possible, but index 0 is likely still correct if only 1 text area
            assert at.text_area(key="script_editor_area").value == "Generated script"
    
            # Verify audio generation section appears (2nd selectbox)
            assert len(at.selectbox) >= 2, f"Audio section not rendered. Selectboxes: {len(at.selectbox)}"
    
            # Verify client call
>           mock_client.generate_script.assert_called_with("doc_1")

tests\test_education_audio_integration.py:101: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <AsyncMock name='mock.generate_script' id='2289235760080'>
args = ('doc_1',), kwargs = {}, expected = call('doc_1')
actual = call(knowledge_id='doc_1', model_name='gemini-2.5-flash', custom_prompt=None)
_error_message = <function NonCallableMock.assert_called_with.<locals>._error_message at 0x0000021509884040>
cause = None

    def assert_called_with(self, /, *args, **kwargs):
        """assert that the last call was made with the specified arguments.
    
        Raises an AssertionError if the args and keyword args passed in are
        different to the last call to the mock."""
        if self.call_args is None:
            expected = self._format_mock_call_signature(args, kwargs)
            actual = 'not called.'
            error_message = ('expected call not found.\nExpected: %s\nActual: %s'
                    % (expected, actual))
            raise AssertionError(error_message)
    
        def _error_message():
            msg = self._format_mock_failure_message(args, kwargs)
            return msg
        expected = self._call_matcher(_Call((args, kwargs), two=True))
        actual = self._call_matcher(self.call_args)
        if actual != expected:
            cause = expected if isinstance(expected, Exception) else None
>           raise AssertionError(_error_message()) from cause
E           AssertionError: expected call not found.
E           Expected: generate_script('doc_1')
E           Actual: generate_script(knowledge_id='doc_1', model_name='gemini-2.5-flash', custom_prompt=None)

..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:923: AssertionError
---------------------------- Captured stderr call -----------------------------
2025-12-23 21:36:08.142 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
2025-12-23 21:36:08.142 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
_________________________ test_audio_generation_flow __________________________

mock_client = <MagicMock id='2289375912336'>

    def test_audio_generation_flow(mock_client):
        """Test selecting a voice and generating audio."""
        with patch("streamlit_app.services.backend_api.get_backend_client", return_value=mock_client):
            at = AppTest.from_file("streamlit_app/pages/3_Education_Audio.py", default_timeout=30)
            at.session_state["IS_TESTING_BACKEND"] = True
            at.run()
    
            # 1. Select Document
            at.selectbox[0].select_index(0).run()
    
            # 2. Generate Script
            at.button(key="generate_script_btn").click().run()
    
            # 3. Select Voice
            # Voice selector should now be visible (index 1)
            assert not at.error, f"Errors: {[e.value for e in at.error]}"
            assert not at.warning, f"Warnings: {[w.value for w in at.warning]}"
    
            assert len(at.selectbox) >= 2
            # "Rachel" is at index 0 of the voices list (mocked)
>           at.selectbox[1].select("Rachel").run()

tests\test_education_audio_integration.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
..\..\..\AppData\Local\pypoetry\Cache\virtualenvs\elevendops-GNMsTc5F-py3.11\Lib\site-packages\streamlit\testing\v1\element_tree.py:153: in run
    return self.root.run(timeout=timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\pypoetry\Cache\virtualenvs\elevendops-GNMsTc5F-py3.11\Lib\site-packages\streamlit\testing\v1\element_tree.py:1983: in run
    widget_states = self.get_widget_states()
                    ^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\pypoetry\Cache\virtualenvs\elevendops-GNMsTc5F-py3.11\Lib\site-packages\streamlit\testing\v1\element_tree.py:1966: in get_widget_states
    w = get_widget_state(node)
        ^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\pypoetry\Cache\virtualenvs\elevendops-GNMsTc5F-py3.11\Lib\site-packages\streamlit\testing\v1\element_tree.py:1910: in get_widget_state
    return node._widget_state
           ^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\pypoetry\Cache\virtualenvs\elevendops-GNMsTc5F-py3.11\Lib\site-packages\streamlit\testing\v1\element_tree.py:1069: in _widget_state
    if self.index is not None and len(self.options) > 0:
       ^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Selectbox(_value='Rachel', label='AI Model', options=['gemini-2.5-pro', 'gemini-2.5-flash', 'gemini-2.0-flash'], help='Select the AI model for script generation')

    @property
    def index(self) -> int | None:
        """The index of the current selection. (int)"""  # noqa: D400
        if self.value is None:
            return None
    
        if len(self.options) == 0:
            return 0
>       return self.options.index(self.format_func(self.value))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       ValueError: 'Rachel' is not in list

..\..\..\AppData\Local\pypoetry\Cache\virtualenvs\elevendops-GNMsTc5F-py3.11\Lib\site-packages\streamlit\testing\v1\element_tree.py:1029: ValueError
---------------------------- Captured stderr call -----------------------------
2025-12-23 21:36:08.281 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
2025-12-23 21:36:08.281 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
=========================== short test summary info ===========================
FAILED tests/test_education_audio_integration.py::test_script_generation_flow
FAILED tests/test_education_audio_integration.py::test_audio_generation_flow
========================= 2 failed, 2 passed in 2.03s =========================
