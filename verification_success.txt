============================= test session starts =============================
platform win32 -- Python 3.11.0, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\Users\Cheney\Documents\Github\ElevenDops
configfile: pyproject.toml
plugins: anyio-4.12.0, hypothesis-6.148.8, langsmith-0.5.1, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 6 items

tests\test_education_audio_integration.py ....                           [ 66%]
tests\test_script_generation_frontend_props.py .F                        [100%]

================================== FAILURES ===================================
______________________ test_script_generation_parameters ______________________

mock_client = <MagicMock id='3008370494736'>

    def test_script_generation_parameters(mock_client):
        """Verify parameters passed to backend."""
        with patch("streamlit_app.services.backend_api.get_backend_client", return_value=mock_client), \
             patch("streamlit_app.services.cached_data.get_documents_cached", return_value=MOCK_DOCS):
            at = AppTest.from_file("streamlit_app/pages/3_Education_Audio.py", default_timeout=30)
            at.session_state["IS_TESTING_BACKEND"] = True
            at.run()
    
            # Select Doc
            at.selectbox[0].select_index(0).run()
    
            # Select Model (valid option)
            at.selectbox[1].select("gemini-3-pro-preview").run()
    
            # Set custom prompt directly in session state since dialog testing is hard
            at.session_state.custom_prompt = "My custom prompt"
            # Disable template mode to ensure custom prompt is used
            at.session_state.use_template_mode = False
            at.run()
    
            # Click Generate
            at.button(key="generate_script_btn").click().run()
    
            # Check backend call - assert on generate_script_stream
>           mock_client.generate_script_stream.assert_called_with(
                knowledge_id="doc_1",
                model_name="gemini-3-pro-preview",
                custom_prompt="My custom prompt",
                template_ids=["pre_surgery"],
                quick_instructions="",
                system_prompt_override=None
            )

tests\test_script_generation_frontend_props.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock name='mock.generate_script_stream' id='3008369937232'>
args = ()
kwargs = {'custom_prompt': 'My custom prompt', 'knowledge_id': 'doc_1', 'model_name': 'gemini-3-pro-preview', 'quick_instructions': '', ...}
expected = call(knowledge_id='doc_1', model_name='gemini-3-pro-preview', custom_prompt='My custom prompt', template_ids=['pre_surgery'], quick_instructions='', system_prompt_override=None)
actual = call(knowledge_id='doc_1', model_name='gemini-3-pro-preview', custom_prompt='My custom prompt', template_ids=None, quick_instructions=None, system_prompt_override=None)
_error_message = <function NonCallableMock.assert_called_with.<locals>._error_message at 0x000002BC70D79440>
cause = None

    def assert_called_with(self, /, *args, **kwargs):
        """assert that the last call was made with the specified arguments.
    
        Raises an AssertionError if the args and keyword args passed in are
        different to the last call to the mock."""
        if self.call_args is None:
            expected = self._format_mock_call_signature(args, kwargs)
            actual = 'not called.'
            error_message = ('expected call not found.\nExpected: %s\nActual: %s'
                    % (expected, actual))
            raise AssertionError(error_message)
    
        def _error_message():
            msg = self._format_mock_failure_message(args, kwargs)
            return msg
        expected = self._call_matcher(_Call((args, kwargs), two=True))
        actual = self._call_matcher(self.call_args)
        if actual != expected:
            cause = expected if isinstance(expected, Exception) else None
>           raise AssertionError(_error_message()) from cause
E           AssertionError: expected call not found.
E           Expected: generate_script_stream(knowledge_id='doc_1', model_name='gemini-3-pro-preview', custom_prompt='My custom prompt', template_ids=['pre_surgery'], quick_instructions='', system_prompt_override=None)
E           Actual: generate_script_stream(knowledge_id='doc_1', model_name='gemini-3-pro-preview', custom_prompt='My custom prompt', template_ids=None, quick_instructions=None, system_prompt_override=None)

..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:923: AssertionError
---------------------------- Captured stderr call -----------------------------
2025-12-30 02:22:46.563 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
2025-12-30 02:22:46.563 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
2025-12-30 02:22:46.748 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
2025-12-30 02:22:46.748 Thread 'MainThread': missing ScriptRunContext! This warning can be ignored when running in bare mode.
============================== warnings summary ===============================
tests/test_education_audio_integration.py::test_script_generation_flow
  C:\Users\Cheney\Documents\Github\ElevenDops\streamlit_app\services\cached_data.py:58: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    return []
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_script_generation_frontend_props.py::test_script_generation_parameters
=================== 1 failed, 5 passed, 1 warning in 4.79s ====================
