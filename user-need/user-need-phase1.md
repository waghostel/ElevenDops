
# ElevenDops ç³»çµ±éœ€æ±‚è¦æ ¼æ›¸ - Phase 1

## 0. ä½¿ç”¨è€…éœ€æ±‚æ¦‚è¿°

### 0.1 ç³»çµ±ç›®æ¨™
å»ºæ§‹ä¸€å€‹çµåˆ ElevenLabs èªéŸ³æŠ€è¡“çš„æ™ºèƒ½é†«ç™‚åŠ©ç†ç³»çµ±ï¼Œæ—¨åœ¨è§£æ±ºé†«ç”Ÿèˆ‡ç—…æ‚£ä¹‹é–“çš„è¡›æ•™æºé€šå•é¡Œï¼Œæå‡é†«ç™‚æœå‹™æ•ˆç‡èˆ‡å“è³ªã€‚

### 0.2 æ ¸å¿ƒå•é¡Œå®šç¾©
- é†«ç”Ÿéœ€è¦é‡è¤‡å‘ä¸åŒç—…æ‚£è§£èªªç›¸åŒçš„åŸºç¤é†«ç™‚è³‡è¨Š
- ç—…æ‚£å°æ–¼ç–¾ç—…ç›¸é—œè³‡è¨Šå­˜åœ¨ç–‘å•ï¼Œä½†ç¼ºä¹å³æ™‚è«®è©¢ç®¡é“
- é†«ç”Ÿç„¡æ³•æœ‰æ•ˆæŒæ¡ç—…æ‚£çš„ç–‘å•é‡é»ï¼Œå½±éŸ¿çœ‹è¨ºæ•ˆç‡

### 0.3 ä¸»è¦åŠŸèƒ½éœ€æ±‚

#### 0.3.1 è¡›æ•™éŸ³æª”éŒ„è£½åŠŸèƒ½
**éœ€æ±‚æè¿°ï¼š** ç³»çµ±æ‡‰æä¾›é‡å°ç‰¹å®šç–¾ç—…çš„åŸºç¤è¡›æ•™éŸ³æª”éŒ„è£½èˆ‡ç®¡ç†åŠŸèƒ½ã€‚

**ä½¿ç”¨æƒ…å¢ƒï¼š** é†«ç”Ÿå¯ä»¥ç‚ºå¸¸è¦‹ç–¾ç—…ï¼ˆå¦‚ç™½å…§éšœæ‰‹è¡“è¡“å¾Œç…§è­·ï¼‰éŒ„è£½æ¨™æº–åŒ–è¡›æ•™èªªæ˜ï¼Œç—…æ‚£å¯ç›´æ¥é»é¸æ”¶è½ç›¸é—œéŸ³æª”ï¼Œç²å¾—åŸºç¤é†«ç™‚è³‡è¨Šã€‚

**é æœŸæ•ˆç›Šï¼š** æ¸›å°‘é†«ç”Ÿé‡è¤‡è§£èªªæ™‚é–“ï¼Œæä¾›ç—…æ‚£24å°æ™‚å¯å­˜å–çš„è¡›æ•™è³‡æºã€‚

#### 0.3.2 èªéŸ³å°è©±è«®è©¢åŠŸèƒ½
**éœ€æ±‚æè¿°ï¼š** ç³»çµ±æ‡‰å…·å‚™èªéŸ³å°è©±èƒ½åŠ›ï¼Œèƒ½å¤ å›ç­”ç—…æ‚£çš„åŸºç¤é†«å­¸å•é¡Œã€‚

**ä½¿ç”¨æƒ…å¢ƒï¼š** ç—…æ‚£å¯é€éèªéŸ³èˆ‡ç³»çµ±äº’å‹•ï¼Œè©¢å•ç–¾ç—…ç›¸é—œçš„åŸºç¤å•é¡Œï¼Œç³»çµ±åŸºæ–¼é†«ç™‚çŸ¥è­˜åº«æä¾›é©ç•¶å›æ‡‰ã€‚

**é æœŸæ•ˆç›Šï¼š** å”åŠ©ç—…æ‚£é‡æ¸…åŸºç¤é†«å­¸è³‡è¨Šï¼Œæ¸›å°‘é†«ç”Ÿè™•ç†é‡è¤‡æ€§å•é¡Œçš„æ™‚é–“è² æ“”ã€‚

#### 0.3.3 å•é¡Œæ”¶é›†èˆ‡åˆ†æåŠŸèƒ½
**éœ€æ±‚æè¿°ï¼š** ç³»çµ±æ‡‰æ”¶é›†ä¸¦åˆ†æç—…æ‚£æå‡ºä½†ç„¡æ³•å›ç­”çš„å•é¡Œï¼Œæä¾›é†«ç”Ÿåƒè€ƒã€‚

**ä½¿ç”¨æƒ…å¢ƒï¼š** ç•¶ç—…æ‚£è©¢å•è¶…å‡ºç³»çµ±çŸ¥è­˜ç¯„åœçš„å•é¡Œæ™‚ï¼Œç³»çµ±æ‡‰è¨˜éŒ„è©²å•é¡Œã€‚é†«ç”Ÿåœ¨çœ‹è¨ºå‰å¯æŸ¥çœ‹ç—…æ‚£æ›¾æå‡ºçš„å•é¡Œæ¸…å–®ï¼Œäº†è§£éœ€è¦é¡å¤–èªªæ˜çš„é‡é»ã€‚

**é æœŸæ•ˆç›Šï¼š** æå‡çœ‹è¨ºæ•ˆç‡ï¼Œç¢ºä¿é†«ç”Ÿèƒ½é‡å°ç—…æ‚£çœŸæ­£é—œå¿ƒçš„å•é¡Œé€²è¡Œæ·±å…¥èªªæ˜ã€‚

### 0.4 ç›®æ¨™ä½¿ç”¨è€…
- **ä¸»è¦ä½¿ç”¨è€…ï¼š** é†«ç™‚æ©Ÿæ§‹çš„åŸ·æ¥­é†«å¸«
- **æ¬¡è¦ä½¿ç”¨è€…ï¼š** æ¥å—é†«ç™‚æœå‹™çš„ç—…æ‚£
- **ç³»çµ±ç®¡ç†è€…ï¼š** é†«ç™‚æ©Ÿæ§‹çš„è³‡è¨ŠæŠ€è¡“äººå“¡

### 0.5 æˆåŠŸæŒ‡æ¨™
- æ¸›å°‘é†«ç”Ÿé‡è¤‡è§£èªªåŸºç¤è³‡è¨Šçš„æ™‚é–“æ¯”ä¾‹
- æå‡ç—…æ‚£å°ç–¾ç—…èªçŸ¥çš„æ»¿æ„åº¦
- å¢åŠ é†«ç”Ÿå°ç—…æ‚£ç–‘å•çš„æŒæ¡ç¨‹åº¦
- ç³»çµ±ä½¿ç”¨ç‡èˆ‡ä½¿ç”¨è€…æ¥å—åº¦

---

## 1. æŠ€è¡“æ¶æ§‹

### 1.1 æ ¸å¿ƒæŠ€è¡“çµ„ä»¶
- **Cloud Run**: å®¹å™¨åŒ–éƒ¨ç½²å¹³å°
- **Firestore**: ä¸»è¦è³‡æ–™åº«ï¼Œä½œç‚ºç³»çµ±è³‡æ–™ä¾†æº
- **ElevenLabs Knowledge Base**: çŸ¥è­˜åº«åŒæ­¥å‰¯æœ¬
- **Streamlit**: é†«ç”Ÿç«¯èˆ‡ç—…æ‚£ç«¯æœ€å°å¯è¡Œç”¢å“(MVP)ä½¿ç”¨è€…ä»‹é¢
- **Backend API**: å¾Œç«¯æ‡‰ç”¨ç¨‹å¼ä»‹é¢ï¼Œæ”¯æ´æœªä¾† Next.js/TypeScript æ•´åˆ

### 1.2 ç³»çµ±æ¶æ§‹åŸå‰‡

#### 1.2.1 è²¬ä»»åˆ†é›¢
ç³»çµ±æ¡ç”¨åˆ†å±¤æ¶æ§‹è¨­è¨ˆï¼Œæ˜ç¢ºå€åˆ†å‰ç«¯å±•ç¤ºå±¤èˆ‡å¾Œç«¯é‚è¼¯å±¤çš„è·è²¬ç¯„åœã€‚

#### 1.2.2 Streamlit è·è²¬ç¯„åœ

**è² è²¬åŠŸèƒ½:**
- é†«ç”Ÿæ“ä½œæµç¨‹ä½¿ç”¨è€…ä»‹é¢
- ç—…æ‚£æ¸¬è©¦ä½¿ç”¨è€…ä»‹é¢  
- å¾Œç«¯APIå‘¼å«
- çµæœå±•ç¤ºï¼ˆéŸ³æª”ã€Agent IDã€å°è©±è¨˜éŒ„ï¼‰

**ä¸è² è²¬åŠŸèƒ½:**
- ç›´æ¥æ“ä½œ ElevenLabs API
- ç›´æ¥åŸ·è¡Œ Firestore CRUD æ“ä½œ
- ç›´æ¥è™•ç† LLM æç¤ºè©
- å•†æ¥­é‚è¼¯åˆ¤æ–·èˆ‡è™•ç†

#### 1.2.3 æ¶æ§‹è¨­è¨ˆè€ƒé‡
å³ä½¿åœ¨ Phase 1 éšæ®µå°‡ API åŠŸèƒ½èˆ‡ Streamlit ç½®æ–¼åŒä¸€ç¨‹å¼åº«ä¸­ï¼Œç¨‹å¼çµæ§‹ä»é ˆä¿æŒæ¨¡çµ„åŒ–åˆ†é›¢è¨­è¨ˆï¼Œä»¥åˆ©å¾ŒçºŒç³»çµ±æ“´å±•ã€‚

---

## 2. ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### 2.1 æ‡‰ç”¨ç¨‹å¼çµæ§‹
ç³»çµ±æ¡ç”¨å–®ä¸€ Streamlit æ‡‰ç”¨ç¨‹å¼æ¶æ§‹ï¼Œé€éå´é‚Šæ¬„é€²è¡Œè§’è‰²åˆ‡æ›ï¼Œæ”¯æ´é†«ç”Ÿç«¯èˆ‡ç—…æ‚£ç«¯åŠŸèƒ½ã€‚

### 2.2 ç›®éŒ„çµæ§‹è¦åŠƒ

```
ğŸ“¦ streamlit_app/
 â”œâ”€ app.py                          # ä¸»æ‡‰ç”¨ç¨‹å¼å…¥å£
 â”œâ”€ pages/                          # é é¢æ¨¡çµ„
 â”‚   â”œâ”€ 1_Doctor_Dashboard.py       # é†«ç”Ÿå„€è¡¨æ¿
 â”‚   â”œâ”€ 2_Upload_Knowledge.py       # çŸ¥è­˜ä¸Šå‚³åŠŸèƒ½
 â”‚   â”œâ”€ 3_Education_Audio.py        # è¡›æ•™éŸ³æª”ç®¡ç†
 â”‚   â”œâ”€ 4_Agent_Setup.py            # æ™ºèƒ½ä»£ç†è¨­å®š
 â”‚   â”œâ”€ 5_Patient_Test.py           # ç—…æ‚£æ¸¬è©¦ä»‹é¢
 â”‚   â””â”€ 6_Conversation_Logs.py      # å°è©±è¨˜éŒ„æŸ¥è©¢
 â””â”€ services/                       # æœå‹™å±¤
     â”œâ”€ backend_api.py              # å¾Œç«¯APIæœå‹™ï¼ˆæ”¯æ´æœªä¾†Next.jsæ•´åˆï¼‰
     â”œâ”€ elevenlabs.py               # ElevenLabsæ•´åˆæœå‹™
     â””â”€ firestore.py                # Firestoreè³‡æ–™åº«æœå‹™
```

---

## 3. é†«ç”Ÿç«¯åŠŸèƒ½éœ€æ±‚

### 3.1 é†«ç”Ÿå„€è¡¨æ¿ (Doctor Dashboard)

#### 3.1.1 åŠŸèƒ½ç›®æ¨™
æä¾›é†«ç”Ÿç³»çµ±ç‹€æ…‹ç¸½è¦½ï¼Œå¯¦ç¾å¿«é€Ÿç‹€æ…‹ç›£æ§èˆ‡ç®¡ç†ã€‚

#### 3.1.2 é¡¯ç¤ºå…§å®¹éœ€æ±‚
- å·²ä¸Šå‚³è¡›æ•™æ–‡ä»¶çµ±è¨ˆ
- å·²å»ºç«‹æ™ºèƒ½ä»£ç†æ•¸é‡
- å·²ç”¢ç”Ÿè¡›æ•™éŸ³æª”çµ±è¨ˆ
- æœ€è¿‘ç—…æ‚£æ¸¬è©¦æ´»å‹•æ™‚é–“

#### 3.1.3 æŠ€è¡“å¯¦ä½œè¦æ±‚
- è³‡æ–™ä¾†æºï¼šFirestore è³‡æ–™åº«æ‘˜è¦è³‡è¨Š
- é¿å…ç›´æ¥å‘¼å« ElevenLabs API
- å¯¦ä½œå³æ™‚è³‡æ–™æ›´æ–°æ©Ÿåˆ¶

---

### 3.2 çŸ¥è­˜ä¸Šå‚³åŠŸèƒ½ (Upload Knowledge)

#### 3.2.1 ä½¿ç”¨è€…æ“ä½œæµç¨‹
1. ä¸Šå‚³ Markdown æˆ– TXT æ ¼å¼æ–‡ä»¶
2. å¡«å¯«æ–‡ä»¶åŸºæœ¬è³‡è¨Šï¼š
   - ç–¾ç—…åç¨±
   - æ–‡ä»¶é¡å‹ï¼ˆå¸¸è¦‹å•é¡Œ/è¡“å¾Œç…§è­·/æ³¨æ„äº‹é …ï¼‰
3. åŸ·è¡Œã€Œå„²å­˜ä¸¦åŒæ­¥ã€æ“ä½œ

#### 3.2.2 å¾Œç«¯è™•ç†æµç¨‹

**Firestore è³‡æ–™å„²å­˜ï¼š**
- knowledge_idï¼šçŸ¥è­˜æ–‡ä»¶å”¯ä¸€è­˜åˆ¥ç¢¼
- doctor_idï¼šé†«ç”Ÿè­˜åˆ¥ç¢¼
- raw_markdownï¼šåŸå§‹æ–‡ä»¶å…§å®¹
- structured_sectionsï¼šçµæ§‹åŒ–ç« ç¯€è³‡æ–™
- created_atï¼šå»ºç«‹æ™‚é–“æˆ³è¨˜

**ElevenLabs Knowledge Base åŒæ­¥ï¼š**
- document_idï¼šæ–‡ä»¶è­˜åˆ¥ç¢¼
- agent_idï¼šæ™ºèƒ½ä»£ç†è­˜åˆ¥ç¢¼

#### 3.2.3 è³‡æ–™æ¶æ§‹è¨­è¨ˆåŸå‰‡
- Firestore ä½œç‚ºä¸»è¦è³‡æ–™ä¾†æº
- ElevenLabs Knowledge Base åƒ…å„²å­˜åƒè€ƒè³‡æ–™
- Firestore ç¶­è­· elevenlabs_document_id å°æ‡‰é—œä¿‚

---

### 3.3 è¡›æ•™éŸ³æª”è£½ä½œåŠŸèƒ½ (Education Audio)

#### 3.3.1 ä½¿ç”¨è€…æ“ä½œæµç¨‹
1. é¸æ“‡å·²ä¸Šå‚³çš„è¡›æ•™è³‡æ–™
2. åŸ·è¡Œã€Œç”¢ç”Ÿè¡›æ•™è¬›ç¨¿é è¦½ã€åŠŸèƒ½
3. ç·¨è¼¯ä¸¦ç¢ºèªè¬›ç¨¿å…§å®¹
4. åŸ·è¡Œã€Œç”¢ç”ŸèªéŸ³ã€åŠŸèƒ½

#### 3.3.2 å¾Œç«¯è™•ç†æµç¨‹
```
Firestore çŸ¥è­˜è³‡æ–™ â†’
LLM è¬›ç¨¿ç”Ÿæˆ â†’
é†«ç”Ÿç¢ºèªå¯©æ ¸ â†’
ElevenLabs TTS è½‰æ› â†’
GCS Storage å„²å­˜ â†’
Firestore éŸ³æª”å…ƒè³‡æ–™æ›´æ–°
```

#### 3.3.3 ä½¿ç”¨è€…ä»‹é¢é¡¯ç¤ºéœ€æ±‚
- è¬›ç¨¿é è¦½æ–‡å­—å€åŸŸ
- éŸ³æª”æ’­æ”¾æ§åˆ¶å…ƒä»¶
- éŸ³æª” URL é¡¯ç¤º

#### 3.3.4 é†«ç™‚åˆè¦è¦æ±‚
ç³»çµ±å¿…é ˆå¯¦ä½œé†«ç”Ÿç¢ºèªæ©Ÿåˆ¶ï¼Œç¢ºä¿æ‰€æœ‰è¡›æ•™å…§å®¹ç¶“éå°ˆæ¥­é†«ç™‚äººå“¡å¯©æ ¸å¾Œæ–¹å¯ç™¼å¸ƒï¼Œä»¥ç¬¦åˆé†«ç™‚è³‡è¨Šåˆè¦æ¨™æº–ã€‚

---

### 3.4 æ™ºèƒ½ä»£ç†è¨­å®šåŠŸèƒ½ (Agent Setup)

#### 3.4.1 å¯è¨­å®šé …ç›® (MVPéšæ®µ)
- æ™ºèƒ½ä»£ç†åç¨±
- é—œè¯çŸ¥è­˜åº«ï¼ˆæ”¯æ´å¤šé¸ï¼‰
- èªéŸ³æ¨¡å‹é¸æ“‡
- å›ç­”é¢¨æ ¼è¨­å®šé¸é …ï¼š
  - ç©©å®šå°ˆæ¥­å‹
  - è¦ªåˆ‡å‹å–„å‹
  - è¡›æ•™å°å‘å‹

#### 3.4.2 å¾Œç«¯åŠŸèƒ½å¯¦ä½œ

**create_or_update_agent() å‡½å¼éœ€æ±‚ï¼š**
- system_promptï¼šç³»çµ±æç¤ºè©è¨­å®š
- knowledge_base_document_idsï¼šçŸ¥è­˜åº«æ–‡ä»¶è­˜åˆ¥ç¢¼æ¸…å–®
- voice_idï¼šèªéŸ³æ¨¡å‹è­˜åˆ¥ç¢¼
- data_collection_schemaï¼šè³‡æ–™æ”¶é›†æ¶æ§‹å®šç¾©

#### 3.4.3 Firestore è³‡æ–™å„²å­˜éœ€æ±‚
- agent_idï¼šæ™ºèƒ½ä»£ç†å”¯ä¸€è­˜åˆ¥ç¢¼
- linked_knowledge_idsï¼šé—œè¯çŸ¥è­˜æ–‡ä»¶è­˜åˆ¥ç¢¼æ¸…å–®
- voice_idï¼šèªéŸ³æ¨¡å‹è­˜åˆ¥ç¢¼
- created_atï¼šå»ºç«‹æ™‚é–“æˆ³è¨˜

---

## 4. ç—…æ‚£ç«¯åŠŸèƒ½éœ€æ±‚

### 4.1 åŠŸèƒ½å®šä½
ç—…æ‚£ç«¯ä»‹é¢ä½œç‚ºç³»çµ±é©—è­‰èˆ‡é«”é©—æ¸¬è©¦å¹³å°ï¼Œéæ­£å¼ç”¢å“ä½¿ç”¨è€…ä»‹é¢ã€‚

### 4.2 ç—…æ‚£æ¸¬è©¦é é¢ (Patient Test Page)

#### 4.2.1 ä½¿ç”¨è€…åŠŸèƒ½éœ€æ±‚
- ç—…æ‚£è­˜åˆ¥ç¢¼è¼¸å…¥
- ç–¾ç—…é¡å‹/æ™ºèƒ½ä»£ç†é¸æ“‡
- è¡›æ•™éŸ³æª”æ’­æ”¾åŠŸèƒ½
- æ™ºèƒ½ä»£ç†èªéŸ³å°è©±åŠŸèƒ½

#### 4.2.2 æŠ€è¡“å¯¦ä½œè¦ç¯„

**Phase 1 éšæ®µæŠ€è¡“é™åˆ¶ï¼š**
- æ”¯æ´ç°¡åŒ–èªéŸ³ä¸²æµè™•ç†
- æ”¯æ´æ–‡å­—è¼¸å…¥æ­é…èªéŸ³è¼¸å‡ºæ¨¡å¼

**å°è©±çµæŸå¾Œè™•ç†æµç¨‹ï¼š**
- å‘¼å« ElevenLabs webhook è™•ç†å™¨
- å°è©±è³‡æ–™å„²å­˜è‡³ Firestore è³‡æ–™åº«

---

### 4.3 å°è©±è¨˜éŒ„æŸ¥è©¢åŠŸèƒ½ (Conversation Logs)

#### 4.3.1 é¡¯ç¤ºå…§å®¹éœ€æ±‚
- ç—…æ‚£è­˜åˆ¥ç¢¼
- æå•è¨˜éŒ„ï¼ˆå·²å›ç­”/æœªå›ç­”ç‹€æ…‹ï¼‰
- æ™ºèƒ½ä»£ç†å›ç­”æ‘˜è¦
- é†«ç”Ÿä»‹å…¥éœ€æ±‚æ¨™è¨˜

#### 4.3.2 åŠŸèƒ½é‡è¦æ€§
æ­¤åŠŸèƒ½ç‚ºç³»çµ±åƒ¹å€¼å±•ç¤ºçš„æ ¸å¿ƒæ¨¡çµ„ï¼Œæä¾›é†«ç™‚æœå‹™å“è³ªç›£æ§èˆ‡æ”¹å–„ä¾æ“šã€‚

---

## 5. éƒ¨ç½²æ¶æ§‹èˆ‡æŠ€è¡“è¦ç¯„

### 5.1 Cloud Run å®¹å™¨æ¶æ§‹ (Phase 1)

```
Cloud Run Service
 â”œâ”€ Streamlit Application        # å‰ç«¯æ‡‰ç”¨ç¨‹å¼
 â”œâ”€ Backend API (FastAPI)        # å¾Œç«¯APIæœå‹™
 â”œâ”€ Firestore Client            # è³‡æ–™åº«å®¢æˆ¶ç«¯
 â””â”€ ElevenLabs Client           # ElevenLabsæ•´åˆå®¢æˆ¶ç«¯
```

### 5.2 API ä»‹é¢è¨­è¨ˆè¦ç¯„

ç‚ºç¢ºä¿æœªä¾†ç³»çµ±æ“´å±•æ€§ï¼ŒAPI ä»‹é¢è¨­è¨ˆé ˆéµå¾ª RESTful åŸå‰‡ï¼š

```
POST /api/knowledge              # çŸ¥è­˜è³‡æ–™ç®¡ç†
POST /api/audio                  # éŸ³æª”è™•ç†
POST /api/agent                  # æ™ºèƒ½ä»£ç†ç®¡ç†
POST /api/patient/session        # ç—…æ‚£æœƒè©±ç®¡ç†
GET  /api/patient/{id}/summary   # ç—…æ‚£è³‡æ–™æ‘˜è¦æŸ¥è©¢
```

æ­¤è¨­è¨ˆç¢ºä¿æœªä¾† Next.js å‰ç«¯æ¡†æ¶å¯ç„¡ç¸«æ•´åˆç¾æœ‰ API æœå‹™ã€‚

---

## 6. ElevenLabs API æ•´åˆå¯¦ä½œè¦åŠƒ

### 6.1 API æ•´åˆæ¶æ§‹æ¦‚è¿°

åŸºæ–¼ ElevenLabs å¹³å°çš„å››å¤§æ ¸å¿ƒçµ„ä»¶ï¼Œæœ¬ç³»çµ±å°‡æ•´åˆä»¥ä¸‹æŠ€è¡“æ¨¡çµ„ï¼š

1. **Knowledge Base API** - é†«ç™‚çŸ¥è­˜åº«ç®¡ç†
2. **Agents API** - æ™ºèƒ½é†«ç™‚åŠ©ç†å»ºç«‹èˆ‡é…ç½®
3. **Text-to-Speech API** - è¡›æ•™éŸ³æª”ç”Ÿæˆ
4. **Conversational AI WebSocket** - å³æ™‚èªéŸ³å°è©±

### 6.2 çŸ¥è­˜åº«ç®¡ç†å¯¦ä½œ (Knowledge Base Integration)

#### 6.2.1 API ç«¯é»èˆ‡åŠŸèƒ½å°æ‡‰

**é†«ç”Ÿä¸Šå‚³è¡›æ•™è³‡æ–™æµç¨‹ï¼š**
```python
# 1. å»ºç«‹çŸ¥è­˜åº«æ–‡ä»¶ (å°æ‡‰ Upload Knowledge åŠŸèƒ½)
knowledge_base_document = client.conversational_ai.knowledge_base.documents.create_from_text(
    text=markdown_content,  # ä¾†è‡ª Firestore çš„ raw_markdown
    name=f"{disease_name}_{document_type}",  # ç–¾ç—…åç¨±_æ–‡ä»¶é¡å‹
)

# 2. å„²å­˜æ–‡ä»¶ ID è‡³ Firestore
firestore_data = {
    "knowledge_id": knowledge_id,
    "elevenlabs_document_id": knowledge_base_document.id,
    "doctor_id": doctor_id,
    "disease_name": disease_name,
    "document_type": document_type,
    "sync_status": "completed"
}
```

#### 6.2.2 çŸ¥è­˜åº«åŒæ­¥ç­–ç•¥

**è³‡æ–™æµå‘è¨­è¨ˆï¼š**
- **ä¸»è¦è³‡æ–™æº**: Firestore (raw_markdown, structured_sections)
- **ElevenLabs å‰¯æœ¬**: åƒ…å„²å­˜ Agent æŸ¥è©¢æ‰€éœ€çš„è™•ç†å¾Œå…§å®¹
- **åŒæ­¥è§¸ç™¼**: é†«ç”ŸåŸ·è¡Œã€Œå„²å­˜ä¸¦åŒæ­¥ã€æ“ä½œæ™‚

**éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼š**
- åŒæ­¥å¤±æ•—æ™‚ä¿ç•™ Firestore åŸå§‹è³‡æ–™
- å¯¦ä½œé‡è©¦æ©Ÿåˆ¶èˆ‡ç‹€æ…‹è¿½è¹¤
- æä¾›æ‰‹å‹•é‡æ–°åŒæ­¥åŠŸèƒ½

### 6.3 æ™ºèƒ½ä»£ç†å»ºç«‹èˆ‡é…ç½® (Agents API Integration)

#### 6.3.1 Agent å»ºç«‹æµç¨‹å¯¦ä½œ

**create_or_update_agent() å‡½å¼å¯¦ä½œï¼š**
```python
def create_or_update_agent(agent_config):
    # 1. æº–å‚™ç³»çµ±æç¤ºè© (åŸºæ–¼å›ç­”é¢¨æ ¼è¨­å®š)
    system_prompts = {
        "professional": "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é†«ç™‚åŠ©ç†ï¼Œè«‹ä»¥æº–ç¢ºã€å®¢è§€çš„æ–¹å¼å›ç­”ç—…æ‚£å•é¡Œ...",
        "friendly": "ä½ æ˜¯ä¸€ä½è¦ªåˆ‡çš„é†«ç™‚åŠ©ç†ï¼Œè«‹ä»¥æº«æš–ã€æ˜“æ‡‚çš„æ–¹å¼å”åŠ©ç—…æ‚£...",
        "educational": "ä½ æ˜¯ä¸€ä½è¡›æ•™å°ˆå“¡ï¼Œè«‹é‡é»æä¾›æ•™è‚²æ€§çš„é†«ç™‚è³‡è¨Š..."
    }
    
    # 2. å»ºç«‹æˆ–æ›´æ–° Agent
    agent = client.conversational_ai.agents.create_or_update(
        agent_id=agent_config.get("agent_id"),
        conversation_config={
            "agent": {
                "prompt": {
                    "system": system_prompts[agent_config["answer_style"]],
                    "knowledge_base": [
                        {
                            "type": "text",
                            "id": doc_id,
                            "name": doc_name
                        } for doc_id, doc_name in agent_config["knowledge_documents"]
                    ]
                }
            }
        },
        voice_id=agent_config["voice_id"]
    )
    
    return agent
```

#### 6.3.2 è³‡æ–™æ”¶é›†æ¶æ§‹è¨­å®š

**é†«ç™‚è³‡è¨Šæ“·å–é…ç½®ï¼š**
```python
data_collection_schema = [
    {
        "identifier": "patient_main_concern",
        "data_type": "string",
        "description": "ç—…æ‚£ä¸»è¦é—œå¿ƒçš„å•é¡Œæˆ–ç—‡ç‹€"
    },
    {
        "identifier": "question_category",
        "data_type": "string", 
        "description": "å•é¡Œåˆ†é¡ï¼šè¡“å¾Œç…§è­·/è—¥ç‰©ç›¸é—œ/ç—‡ç‹€è©¢å•/å…¶ä»–"
    },
    {
        "identifier": "requires_doctor_attention",
        "data_type": "boolean",
        "description": "æ˜¯å¦éœ€è¦é†«ç”Ÿé€²ä¸€æ­¥é—œæ³¨"
    },
    {
        "identifier": "patient_satisfaction",
        "data_type": "integer",
        "description": "ç—…æ‚£å°å›ç­”çš„æ»¿æ„åº¦ (1-5åˆ†)"
    }
]
```

### 6.4 è¡›æ•™éŸ³æª”ç”Ÿæˆå¯¦ä½œ (Text-to-Speech Integration)

#### 6.4.1 TTS API æ•´åˆæµç¨‹

**è¡›æ•™éŸ³æª”è£½ä½œæµç¨‹ï¼š**
```python
def generate_education_audio(script_content, voice_id, disease_name):
    # 1. ä½¿ç”¨ TTS API ç”ŸæˆéŸ³æª”
    audio_response = client.text_to_speech.convert(
        voice_id=voice_id,
        output_format="mp3_44100_128",  # é«˜å“è³ªéŸ³æª”æ ¼å¼
        text=script_content,
        model_id="eleven_multilingual_v2",  # æ”¯æ´ä¸­æ–‡
        text_normalization="auto"  # è‡ªå‹•æ–‡å­—æ­£è¦åŒ–
    )
    
    # 2. ä¸Šå‚³è‡³ GCS Storage
    audio_url = upload_to_gcs(audio_response, f"education_audio/{disease_name}")
    
    # 3. æ›´æ–° Firestore å…ƒè³‡æ–™
    audio_metadata = {
        "audio_url": audio_url,
        "voice_id": voice_id,
        "script_content": script_content,
        "duration_seconds": calculate_duration(audio_response),
        "created_at": datetime.now()
    }
    
    return audio_metadata
```

#### 6.4.2 ä¸²æµéŸ³æª”æ”¯æ´ (æœªä¾†æ“´å±•)

**å³æ™‚éŸ³æª”ç”Ÿæˆ (Phase 2 è€ƒé‡)ï¼š**
```python
# æ”¯æ´é•·ç¯‡è¡›æ•™å…§å®¹çš„ä¸²æµç”Ÿæˆ
def stream_education_audio(script_content, voice_id):
    return client.text_to_speech.stream(
        voice_id=voice_id,
        output_format="mp3_44100_128",
        text=script_content,
        model_id="eleven_multilingual_v2",
        optimize_streaming_latency=2  # å¼·åŒ–å»¶é²å„ªåŒ–
    )
```

### 6.5 å³æ™‚èªéŸ³å°è©±å¯¦ä½œ (Conversational AI WebSocket)

#### 6.5.1 WebSocket é€£ç·šç®¡ç†

**ç—…æ‚£å°è©±é€£ç·šæµç¨‹ï¼š**
```python
# 1. å–å¾—ç°½å URL (å®‰å…¨æ€§è€ƒé‡)
def get_signed_conversation_url(agent_id, patient_id):
    response = requests.get(
        f"https://api.elevenlabs.io/v1/convai/conversation/get-signed-url",
        params={"agent_id": agent_id},
        headers={"xi-api-key": api_key}
    )
    return response.json()["signed_url"]

# 2. å»ºç«‹ WebSocket é€£ç·š
async def start_patient_conversation(agent_id, patient_id):
    signed_url = get_signed_conversation_url(agent_id, patient_id)
    
    # ä½¿ç”¨ç°½å URL å»ºç«‹å®‰å…¨é€£ç·š
    websocket = await websockets.connect(signed_url)
    
    # ç™¼é€ç—…æ‚£ä¸Šä¸‹æ–‡è³‡è¨Š
    context_update = {
        "type": "contextual_update",
        "text": f"ç—…æ‚£ID: {patient_id}, é–‹å§‹è«®è©¢æœƒè©±"
    }
    await websocket.send(json.dumps(context_update))
    
    return websocket
```

#### 6.5.2 å°è©±äº‹ä»¶è™•ç†

**å³æ™‚å°è©±ç®¡ç†ï¼š**
```python
async def handle_conversation_events(websocket, patient_id):
    async for message in websocket:
        event = json.loads(message)
        
        if event["type"] == "agent_response":
            # å„²å­˜ Agent å›æ‡‰è‡³ Firestore
            save_conversation_turn(
                patient_id=patient_id,
                role="agent", 
                message=event["message"],
                timestamp=event["time_in_call_secs"]
            )
            
        elif event["type"] == "user_transcript":
            # å„²å­˜ç—…æ‚£å•é¡Œè‡³ Firestore
            save_conversation_turn(
                patient_id=patient_id,
                role="user",
                message=event["message"], 
                timestamp=event["time_in_call_secs"]
            )
```

### 6.6 å°è©±è³‡æ–™æ”¶é›†èˆ‡åˆ†æ (Data Collection Integration)

#### 6.6.1 å°è©±çµæŸå¾Œè™•ç†

**Webhook äº‹ä»¶è™•ç†ï¼š**
```python
def process_conversation_webhook(conversation_data):
    conversation_id = conversation_data["conversation_id"]
    
    # 1. å–å¾—å®Œæ•´å°è©±è¨˜éŒ„
    conversation_details = client.conversational_ai.conversations.get(
        conversation_id=conversation_id
    )
    
    # 2. æ“·å–çµæ§‹åŒ–è³‡æ–™
    extracted_data = conversation_details.get("analysis", {})
    
    # 3. å„²å­˜è‡³ Firestore ä¾›é†«ç”ŸæŸ¥è©¢
    conversation_summary = {
        "patient_id": extract_patient_id(conversation_data),
        "agent_id": conversation_data["agent_id"],
        "transcript": conversation_details["transcript"],
        "extracted_data": extracted_data,
        "requires_doctor_attention": extracted_data.get("requires_doctor_attention", False),
        "main_concerns": extracted_data.get("patient_main_concern", ""),
        "conversation_duration": conversation_details["metadata"]["call_duration_secs"],
        "created_at": datetime.now()
    }
    
    return save_conversation_summary(conversation_summary)
```

#### 6.6.2 é†«ç”Ÿç«¯è³‡æ–™æŸ¥è©¢

**å°è©±è¨˜éŒ„æŸ¥è©¢ APIï¼š**
```python
def get_patient_conversation_summary(patient_id, doctor_id):
    # å¾ Firestore æŸ¥è©¢ç—…æ‚£å°è©±è¨˜éŒ„
    conversations = firestore_client.collection("conversations")\
        .where("patient_id", "==", patient_id)\
        .where("doctor_id", "==", doctor_id)\
        .order_by("created_at", direction="DESCENDING")\
        .get()
    
    summary = {
        "answered_questions": [],
        "unanswered_questions": [],
        "requires_attention": [],
        "satisfaction_scores": []
    }
    
    for conv in conversations:
        data = conv.to_dict()
        if data.get("requires_doctor_attention"):
            summary["requires_attention"].append(data)
        # å…¶ä»–åˆ†é¡é‚è¼¯...
    
    return summary
```

### 6.7 èªè­‰èˆ‡å®‰å…¨æ€§å¯¦ä½œ (Authentication Integration)

#### 6.7.1 API é‡‘é‘°ç®¡ç†

**ç’°å¢ƒè®Šæ•¸é…ç½®ï¼š**
```python
import os
from elevenlabs import ElevenLabs

# å®‰å…¨çš„ API é‡‘é‘°ç®¡ç†
client = ElevenLabs(
    api_key=os.getenv("ELEVENLABS_API_KEY"),
    base_url="https://api.elevenlabs.io"
)
```

#### 6.7.2 ç°½å URL å®‰å…¨æ©Ÿåˆ¶

**ç—…æ‚£ç«¯å­˜å–æ§åˆ¶ï¼š**
- ä½¿ç”¨ç°½å URL é¿å…æš´éœ² API é‡‘é‘°
- 15åˆ†é˜è‡ªå‹•éæœŸæ©Ÿåˆ¶
- ç—…æ‚£ ID èˆ‡æœƒè©±ç¶å®šé©—è­‰

### 6.8 éŒ¯èª¤è™•ç†èˆ‡ç›£æ§

#### 6.8.1 API å‘¼å«éŒ¯èª¤è™•ç†

**é‡è©¦æ©Ÿåˆ¶èˆ‡é™ç´šç­–ç•¥ï¼š**
```python
import backoff
from elevenlabs.exceptions import ElevenLabsError

@backoff.on_exception(backoff.expo, ElevenLabsError, max_tries=3)
def robust_api_call(api_function, *args, **kwargs):
    try:
        return api_function(*args, **kwargs)
    except ElevenLabsError as e:
        # è¨˜éŒ„éŒ¯èª¤ä¸¦å¯¦ä½œé™ç´šç­–ç•¥
        log_api_error(e)
        if "quota_exceeded" in str(e):
            return handle_quota_exceeded()
        raise
```

#### 6.8.2 ä½¿ç”¨é‡ç›£æ§

**API ä½¿ç”¨é‡è¿½è¹¤ï¼š**
- æ•´åˆ Usage Analytics API ç›£æ§ç³»çµ±ä½¿ç”¨ç‹€æ³
- å¯¦ä½œç”¨é‡è­¦å‘Šæ©Ÿåˆ¶
- æˆæœ¬æ§åˆ¶èˆ‡é ç®—ç®¡ç†

### 6.9 Phase 1 å¯¦ä½œå„ªå…ˆé †åº

#### 6.9.1 æ ¸å¿ƒåŠŸèƒ½å¯¦ä½œé †åº
1. **Knowledge Base API** - é†«ç™‚çŸ¥è­˜ä¸Šå‚³èˆ‡åŒæ­¥
2. **Agents API** - åŸºç¤æ™ºèƒ½ä»£ç†å»ºç«‹
3. **TTS API** - è¡›æ•™éŸ³æª”ç”Ÿæˆ
4. **WebSocket API** - ç°¡åŒ–ç‰ˆèªéŸ³å°è©± (æ–‡å­—è¼¸å…¥/èªéŸ³è¼¸å‡º)
5. **Data Collection** - å°è©±è¨˜éŒ„èˆ‡åˆ†æ

#### 6.9.2 æŠ€è¡“å‚µå‹™ç®¡ç†
- é ç•™å®Œæ•´ WebSocket èªéŸ³ä¸²æµå¯¦ä½œç©ºé–“
- ä¿æŒ API ä»‹é¢è¨­è¨ˆçš„æ“´å±•æ€§
- ç¢ºä¿æ‰€æœ‰ ElevenLabs æ•´åˆæ¨¡çµ„å¯ç¨ç«‹æ¸¬è©¦èˆ‡éƒ¨ç½²

---

## 7. Phase 1 è¨­è¨ˆåŸå‰‡ç¸½çµ

### 7.1 æ ¸å¿ƒè¨­è¨ˆåŸå‰‡
- **Firestore**: ç³»çµ±ä¸»è¦è³‡æ–™åº«
- **ElevenLabs Knowledge Base**: æ™ºèƒ½ä»£ç†å°ˆç”¨è³‡æ–™å‰¯æœ¬
- **Streamlit**: ä½¿ç”¨è€…ä»‹é¢å±¤ï¼Œä¸åŒ…å«æ¥­å‹™é‚è¼¯
- **Backend API**: æ ¸å¿ƒç”¢å“é‚è¼¯å±¤
- **æ¶æ§‹æ“´å±•æ€§**: æ‰€æœ‰æ¨¡çµ„è¨­è¨ˆæ”¯æ´æœªä¾† React/Next.js æ¡†æ¶æ•´åˆ

### 7.2 ElevenLabs æ•´åˆç­–ç•¥
- **API å°è£**: æ‰€æœ‰ ElevenLabs API å‘¼å«å°è£æ–¼ services/elevenlabs.py
- **éŒ¯èª¤è™•ç†**: å¯¦ä½œå®Œæ•´çš„é‡è©¦æ©Ÿåˆ¶èˆ‡é™ç´šç­–ç•¥  
- **å®‰å…¨æ€§**: ä½¿ç”¨ç°½å URL èˆ‡ç’°å¢ƒè®Šæ•¸ç®¡ç†æ•æ„Ÿè³‡è¨Š
- **ç›£æ§**: æ•´åˆä½¿ç”¨é‡è¿½è¹¤èˆ‡æˆæœ¬æ§åˆ¶æ©Ÿåˆ¶

### 7.3 ç³»çµ±ç™¼å±•ç­–ç•¥
Phase 1 éšæ®µæ¡ç”¨ MVP é–‹ç™¼æ¨¡å¼ï¼Œç¢ºä¿æ ¸å¿ƒåŠŸèƒ½å®Œæ•´æ€§çš„åŒæ™‚ï¼Œç‚ºå¾ŒçºŒç³»çµ±æ“´å±•é ç•™å……åˆ†çš„æŠ€è¡“å½ˆæ€§èˆ‡æ•´åˆèƒ½åŠ›ã€‚é€éå®Œæ•´çš„ ElevenLabs API æ•´åˆï¼Œç³»çµ±å°‡å…·å‚™ä¼æ¥­ç´šçš„èªéŸ³ AI èƒ½åŠ›ï¼Œç‚ºé†«ç™‚è¡›æ•™æœå‹™æä¾›å‰µæ–°çš„è§£æ±ºæ–¹æ¡ˆã€‚

