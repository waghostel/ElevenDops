# Requirements Document

## Introduction

This document specifies the requirements for the Storage Service component of the ElevenDops medical assistant system. The Storage Service provides a unified interface for audio file storage that works seamlessly with both the fake-gcs-server emulator (local development) and Google Cloud Storage (production). This enables the "minimize code rewriting" design principle where the same application code works in both environments with only configuration changes.

## Glossary

- **Storage Service**: A backend service component responsible for uploading, retrieving, and deleting audio files from cloud storage
- **GCS**: Google Cloud Storage - Google's cloud-based object storage service
- **fake-gcs-server**: An open-source emulator that mimics the GCS API for local development
- **Bucket**: A container in GCS that holds objects (files)
- **Blob**: An object stored in a GCS bucket, representing a file
- **Audio File**: MP3 format audio files generated by ElevenLabs TTS for patient education
- **Emulator Mode**: Local development mode using fake-gcs-server instead of production GCS
- **Production Mode**: Cloud deployment mode using real Google Cloud Storage

## Requirements

### Requirement 1

**User Story:** As a backend developer, I want to initialize a storage client that automatically connects to either the emulator or production GCS based on configuration, so that the same code works in both environments.

#### Acceptance Criteria

1. WHEN the Storage Service initializes with `USE_GCS_EMULATOR=true` THEN the Storage Service SHALL create a client using AnonymousCredentials and connect to the configured emulator host
2. WHEN the Storage Service initializes with `USE_GCS_EMULATOR=false` THEN the Storage Service SHALL create a client using default Google Cloud credentials
3. WHEN the Storage Service initializes THEN the Storage Service SHALL verify the configured bucket exists or create it if missing
4. IF bucket creation fails in production mode THEN the Storage Service SHALL raise an appropriate error with a descriptive message

### Requirement 2

**User Story:** As a backend service, I want to upload audio files to storage and receive a publicly accessible URL, so that patients can stream education audio content.

#### Acceptance Criteria

1. WHEN the upload_audio method receives audio bytes and a filename THEN the Storage Service SHALL store the file in the `audio/` prefix within the configured bucket
2. WHEN uploading audio THEN the Storage Service SHALL set the content type to `audio/mpeg`
3. WHEN upload completes in emulator mode THEN the Storage Service SHALL return a URL in the format `{emulator_host}/storage/v1/b/{bucket}/o/audio%2F{filename}?alt=media`
4. WHEN upload completes in production mode THEN the Storage Service SHALL return a URL in the format `https://storage.googleapis.com/{bucket}/audio/{filename}`
5. IF upload fails THEN the Storage Service SHALL raise an appropriate error with the failure reason

### Requirement 3

**User Story:** As a backend service, I want to delete audio files from storage, so that obsolete education audio can be removed to manage storage costs.

#### Acceptance Criteria

1. WHEN the delete_audio method receives a filename THEN the Storage Service SHALL remove the file from the `audio/` prefix in the configured bucket
2. WHEN deletion succeeds THEN the Storage Service SHALL return True
3. IF the file does not exist THEN the Storage Service SHALL handle the error gracefully and return False
4. IF deletion fails for other reasons THEN the Storage Service SHALL raise an appropriate error with the failure reason

### Requirement 4

**User Story:** As a backend developer, I want a factory function to obtain a Storage Service instance, so that dependency injection patterns can be used throughout the application.

#### Acceptance Criteria

1. WHEN get_storage_service is called THEN the function SHALL return a properly initialized StorageService instance
2. WHEN the factory function is called multiple times THEN each call SHALL return a functional StorageService instance

### Requirement 5

**User Story:** As a system administrator, I want the Storage Service to read configuration from environment variables, so that deployment settings can be managed without code changes.

#### Acceptance Criteria

1. WHEN the Storage Service initializes THEN the Storage Service SHALL read `USE_GCS_EMULATOR` from Settings to determine the mode
2. WHEN the Storage Service initializes THEN the Storage Service SHALL read `GCS_EMULATOR_HOST` from Settings for emulator connection
3. WHEN the Storage Service initializes THEN the Storage Service SHALL read `GCS_BUCKET_NAME` from Settings for the target bucket
4. WHEN the Storage Service initializes THEN the Storage Service SHALL read `GOOGLE_CLOUD_PROJECT` from Settings for the project identifier
